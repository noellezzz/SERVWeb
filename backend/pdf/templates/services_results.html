{% load static %}
{% load mathfilters %}
<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ service.name }} - Service Report</title>
    <style>
      @page {
        size: A4;
        margin: 2cm;

        @top-center {
          content: "SERV Employee Performance Report";
          font-size: 10pt;
        }

        @bottom-center {
          content: "Page " counter(page) " of " counter(pages);
          font-size: 10pt;
        }
      }

      body {
        font-family: Arial, sans-serif;
        color: #333;
        line-height: 1.5;
        margin: 0;
        padding: 0;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 10px;
        border-bottom: 2px solid #0056b3;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .header img {
        height: 60px;
        margin-right: 20px;
      }

      .header h1 {
        margin: 0;
        color: #0056b3;
        font-size: 24px;
      }

      .report-date {
        text-align: right;
        font-style: italic;
        margin-bottom: 20px;
        font-size: 12px;
      }

      .section {
        margin-bottom: 30px;
      }

      .section-title {
        background-color: #0056b3;
        color: white;
        padding: 8px 15px;
        font-size: 18px;
        margin-bottom: 15px;
        border-radius: 4px;
      }

      .employee-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .info-group {
        margin-bottom: 10px;
      }

      .info-label {
        font-weight: bold;
        color: #555;
        font-size: 14px;
        margin-bottom: 3px;
      }

      .info-value {
        font-size: 16px;
      }

      .services-list {
        margin-top: 15px;
      }

      .service-item {
        background-color: #f5f5f5;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        border-left: 4px solid #0056b3;
      }

      .service-name {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 5px;
      }

      .service-description {
        font-size: 14px;
        color: #555;
      }

      .service-category {
        font-size: 12px;
        color: #777;
        font-style: italic;
        margin-top: 5px;
      }

      .feedback-section {
        margin-top: 30px;
      }

      .feedback-card {
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
      }

      .feedback-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 1px solid #eee;
      }

      .feedback-from {
        font-weight: bold;
      }

      .feedback-date {
        font-size: 12px;
        color: #777;
      }

      .feedback-rating {
        margin-top: 10px;
        font-weight: bold;
      }

      .feedback-content {
        margin-top: 10px;
        font-style: italic;
        padding: 10px;
        background-color: #f9f9f9;
        border-radius: 4px;
      }

      .sentiment-results {
        margin-top: 15px;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 4px;
      }

      .sentiment-label {
        font-weight: bold;
        color: #555;
      }

      .very-negative {
        color: #d32f2f;
      }

      .negative {
        color: #f44336;
      }

      .neutral {
        color: #757575;
      }

      .positive {
        color: #4caf50;
      }

      .very-positive {
        color: #2e7d32;
      }

      .performance-summary {
        margin-top: 30px;
        padding: 15px;
        background-color: #e3f2fd;
        border-radius: 4px;
        border-left: 5px solid #0056b3;
      }

      .score-display {
        display: flex;
        align-items: center;
        margin: 15px 0;
      }

      .score-meter {
        flex-grow: 1;
        height: 20px;
        background-color: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin: 0 15px;
      }

      .score-fill {
        height: 100%;
        background-color: #0056b3;
      }

      .score-number {
        font-weight: bold;
        font-size: 18px;
      }

      .no-data {
        text-align: center;
        padding: 20px;
        color: #777;
        font-style: italic;
      }

      /* Add your existing styles here */
      .performance-summary {
        margin-top: 30px;
        padding: 15px;
        background-color: #e3f2fd;
        border-radius: 4px;
        border-left: 5px solid #0056b3;
      }

      .score-display {
        display: flex;
        align-items: center;
        margin: 15px 0;
      }

      .score-meter {
        flex-grow: 1;
        height: 20px;
        background-color: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin: 0 15px;
      }

      .score-fill {
        height: 100%;
        background-color: #0056b3;
      }

      .score-number {
        font-weight: bold;
        font-size: 18px;
      }

      .no-data {
        text-align: center;
        padding: 20px;
        color: #777;
        font-style: italic;
      }
    </style>
  </head>

  <body>
    <div class="header">
      <img src="{% static 'images/logo.png' %}" alt="SERV Logo" />
      <h1>SERV Sentiment Analysis: {{ service.name }}</h1>
    </div>

    <div class="report-date">
      Report generated on: {{ now|date:"F d, Y" }}
    </div>

    <div class="section">
      <div class="section-title">Service Information</div>
      <div class="employee-info">
        <div>
          <div class="info-group">
            <div class="info-label">Service Name</div>
            <div class="info-value">{{ service.name }}</div>
          </div>
          <div class="info-group">
            <div class="info-label">Description</div>
            <div class="info-value">{{ service.description }}</div>
          </div>
          <div class="info-group">
            <div class="info-label">Category</div>
            <div class="info-value">{{ service.category }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Performance Evaluation</div>
      <div class="score-display">
        <span>Overall Sentiment Score:</span>
        <div class="score-meter">
          <div class="score-fill" style="width: {{ average_sentiment_score|floatformat:2 }}%;"></div>
        </div>
        <span class="score-number">{{ average_sentiment_score|floatformat:2 }}/100</span>
      </div>
      <div class="score-display">
        <span>Overall Performance Score:</span>
        <div class="score-meter">
          <div class="score-fill" style="width: {{ average_performance_score|floatformat:2 }}%;"></div>
        </div>
        <span class="score-number">{{ average_performance_score|floatformat:2 }}/100</span>
      </div>
    </div>

    <div class="section feedback-section">
      <div class="section-title">Customer Feedback</div>

      {% if feedbacks %}
      {% for feedback in feedbacks %}
      <div class="feedback-card">
        <div class="feedback-header">
          <div class="feedback-from">From: {{ feedback.user.user.first_name }} {{ feedback.user.user.last_name }}</div>
          <div class="feedback-date">{{ feedback.created|date:"F d, Y" }}</div>
        </div>

        <div class="feedback-rating">
          Rating: {{ feedback.rating }}/5
        </div>

        <div class="feedback-content">
          "{{ feedback.content }}"
          {% if feedback.sentiment_results.0.details.translated_text %}
          <br><small>(Translated: "{{ feedback.sentiment_results.0.details.translated_text }}")</small>
          {% endif %}
        </div>

        {% if feedback.sentiment_results %}
        <div class="sentiment-results">
          <div>
            <span class="sentiment-label">Sentiment:</span>
            {% with sentiment=feedback.sentiment_results.0.details.prediction.label %}
            <span class="
                          {% if sentiment == 'Very Negative' %}very-negative
                          {% elif sentiment == 'Negative' %}negative
                          {% elif sentiment == 'Neutral' %}neutral
                          {% elif sentiment == 'Positive' %}positive
                          {% elif sentiment == 'Very Positive' %}very-positive
                          {% endif %}
                        ">
              {{ sentiment }}
            </span>
            (Score: {{ feedback.sentiment_results.0.details.prediction.score|floatformat:2 }})
            {% endwith %}
          </div>
          <div>
            <span class="sentiment-label">Emotion Values:</span>
            Valence: {{ feedback.sentiment_results.0.details.valence|floatformat:2 }},
            Arousal: {{ feedback.sentiment_results.0.details.arousal|floatformat:2 }},
            Dominance: {{ feedback.sentiment_results.0.details.dominance|floatformat:2 }}
          </div>
        </div>
        {% endif %}

        <div style="margin-top: 10px;">
          <span class="sentiment-label">Service:</span>
          {% for service in feedback.services %}
          {{ service.name }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
        </div>
      </div>
      {% endfor %}
      {% else %}
      <div class="no-data">No feedback data available for this service.</div>
      {% endif %}
    </div>

    <div class="performance-summary">
      <h3 style="margin-top: 0;">Performance Summary</h3>
      <p>This report summarizes the performance metrics and customer feedback for {{ service.name }}.</p>
      <p>The service has achieved an overall sentiment score of
        <strong>{{ average_sentiment_score|floatformat:2 }}/100</strong> and an overall performance score of
        <strong>{{ average_performance_score|floatformat:2 }}/100</strong>.
      </p>

      {% if feedbacks %}
      {% with total_feedbacks=feedbacks|length %}
      <p>Based on {{ total_feedbacks }} customer feedback{% if total_feedbacks != 1 %}s{% endif %}, the overall customer
        satisfaction with this service is reflected in the reviews and sentiment analysis above.</p>
      {% endwith %}
      {% else %}
      <p>No customer feedback is available at this time. Future evaluations will incorporate customer feedback as it
        becomes available.</p>
      {% endif %}
    </div>
  </body>

</html>